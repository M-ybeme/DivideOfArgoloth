<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <title>The Divide of Argaloth: Initiative Tracker</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css" />

    <!-- Custom CSS -->
    <link href="/css/site.css" rel="stylesheet" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/images/dndFavicon (2).png" />

    <style>
        .bg-orange {
            background-color: #fd7e14 !important;
            color: #212529 !important;
        }
    </style>
</head>
<body class="bgimage">

<!-- NAVBAR OMITTED FOR BREVITY -->

<main class="content my-5 pt-5">
    <div class="container-fluid text-center backdrop">
        <h1 class="display-1 mb-0">Initiative Tracker</h1>
        <p class="lead">Manage initiative, health, notes, and combat rounds.</p>

        <form id="initiative-form" class="mb-4">
            <div class="row g-2">
                <div class="col-md-3"><input id="character-name" class="form-control" type="text" placeholder="Character Name" required></div>
                <div class="col-md-2"><input id="initiative-roll" class="form-control" type="number" placeholder="Initiative" required></div>
                <div class="col-md-2"><input id="character-health" class="form-control" type="number" placeholder="Max HP" required></div>
                <div class="col-md-3"><input id="character-notes" class="form-control" type="text" placeholder="Notes (optional)"></div>
                <div class="col-md-2"><button class="btn btn-primary w-100" type="submit">Add</button></div>
            </div>
        </form>

        <h2>Combat Round: <span id="combat-round">1</span></h2>

        <!-- Desktop Table View -->
        <div class="d-none d-md-block">
            <div class="table-responsive">
                <table class="table table-striped text-light align-middle">
                    <thead>
                        <tr>
                            <th>Turn</th>
                            <th>Character</th>
                            <th>Initiative</th>
                            <th>Health</th>
                            <th>Notes / Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="initiative-order"></tbody>
                </table>
            </div>
        </div>

        <!-- Mobile Card View -->
        <div id="mobile-initiative-order" class="d-block d-md-none"></div>

        <div class="mt-3 d-flex gap-2 justify-content-center flex-wrap">
            <button id="next-turn" class="btn btn-success">Next Turn</button>
            <button id="reset-turns" class="btn btn-danger">Reset</button>
            <button id="clear-all" class="btn btn-outline-danger">Clear All</button>
            <button id="clear-storage" class="btn btn-outline-warning">Clear Saved Data</button>
        </div>
    </div>
</main>

<!-- Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="statusModalLabel">Edit Status Effects</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="status-badges" class="mb-3 d-flex flex-wrap gap-2"></div>
        <input type="text" id="new-status-input" class="form-control" placeholder="Enter new effect">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="save-status-btn">Save</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let characters = [];
let currentTurn = 0;
let combatRound = 1;
let modalCharacterIndex = null;
const modal = new bootstrap.Modal(document.getElementById('statusModal'));

function hpClass(percent) {
    if (percent <= 0) return 'bg-secondary text-light text-decoration-line-through';
    if (percent <= 25) return 'bg-danger text-light';
    if (percent <= 50) return 'bg-warning text-dark';
    if (percent <= 75) return 'bg-orange text-dark';
    return 'bg-success text-light';
}

const saved = localStorage.getItem('initiativeTrackerData');
if (saved) {
    try {
        const data = JSON.parse(saved);
        characters = data.characters || [];
        currentTurn = data.currentTurn || 0;
        combatRound = data.combatRound || 1;
    } catch (e) {
        console.warn("Failed to load saved tracker state:", e);
    }
}

function buildTable() {
    document.getElementById('combat-round').textContent = combatRound;
    const tableBody = document.getElementById('initiative-order');
    const mobileBody = document.getElementById('mobile-initiative-order');
    tableBody.innerHTML = '';
    mobileBody.innerHTML = '';

    characters.forEach((c, i) => {
        const pct = Math.round((c.currentHP / c.maxHP) * 100);

        // Desktop Table Row
        const row = document.createElement('tr');
        if (i === currentTurn) row.classList.add('table-success');
        row.innerHTML = `
            <td>${i === currentTurn ? '<i class="bi bi-caret-right-fill"></i>' : ''}</td>
            <td class="${pct <= 0 ? 'text-decoration-line-through' : ''}">${c.name}</td>
            <td>${c.initiative}</td>
            <td><input type="number" class="form-control form-control-sm health-input ${hpClass(pct)}" value="${c.currentHP}" data-index="${i}"></td>
            <td>
                <input type="text" class="form-control form-control-sm notes-input mb-2" value="${c.notes}" data-index="${i}">
                <button class="btn btn-sm btn-outline-info w-100 status-btn" data-index="${i}" data-bs-toggle="tooltip" title="${c.status.length ? c.status.join(', ') : 'No active effects'}">Status</button>
            </td>
            <td><button class="btn btn-sm btn-outline-danger delete-btn" data-index="${i}"><i class="bi bi-trash"></i></button></td>
        `;
        tableBody.appendChild(row);

        // Mobile Card View
        const card = document.createElement('div');
        card.className = 'card mb-2 text-start';
        if (i === currentTurn) card.classList.add('border-success');
        card.innerHTML = `
            <div class="card-body">
                <h5 class="card-title mb-1">${c.name} <small class="text-muted">(${c.initiative} Init)</small></h5>
                <p class="mb-1">HP: <input type="number" class="form-control form-control-sm health-input ${hpClass(pct)}" value="${c.currentHP}" data-index="${i}"></p>
                <p class="mb-1">Notes: <input type="text" class="form-control form-control-sm notes-input" value="${c.notes}" data-index="${i}"></p>
                <p class="mb-1">Status: <button class="btn btn-sm btn-outline-info status-btn" data-index="${i}" data-bs-toggle="tooltip" title="${c.status.length ? c.status.join(', ') : 'No active effects'}">Status</button></p>
                <button class="btn btn-sm btn-outline-danger delete-btn" data-index="${i}"><i class="bi bi-trash"></i> Remove</button>
            </div>
        `;
        mobileBody.appendChild(card);
    });

    document.querySelectorAll('.health-input').forEach(inp => inp.addEventListener('input', function () {
        const idx = parseInt(this.dataset.index);
        characters[idx].currentHP = isNaN(this.value) ? 0 : parseInt(this.value);
        buildTable();
    }));

    document.querySelectorAll('.notes-input').forEach(inp => inp.addEventListener('input', function () {
        characters[this.dataset.index].notes = this.value;
    }));

    document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', () => deleteChar(btn.dataset.index)));

    document.querySelectorAll('.status-btn').forEach(btn => btn.addEventListener('click', function () {
        modalCharacterIndex = parseInt(this.dataset.index);
        const container = document.getElementById('status-badges');
        const input = document.getElementById('new-status-input');
        const char = characters[modalCharacterIndex];

        input.value = '';
        container.innerHTML = char.status.map(effect =>
            `<span class="badge bg-secondary px-2 py-1">
                ${effect}
                <i class="bi bi-x ms-1 remove-status" data-effect="${effect}" role="button"></i>
            </span>`).join('');

        document.querySelectorAll('.remove-status').forEach(x => x.addEventListener('click', function () {
            const eff = this.dataset.effect;
            characters[modalCharacterIndex].status = characters[modalCharacterIndex].status.filter(s => s !== eff);
            this.parentElement.remove();
        }));

        modal.show();
    }));

    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(t => new bootstrap.Tooltip(t));
}

function deleteChar(idx) {
    characters.splice(idx, 1);
    if (currentTurn >= characters.length) currentTurn = 0;
    if (characters.length === 0) combatRound = 1;
    buildTable();
}

document.getElementById('initiative-form').addEventListener('submit', e => {
    e.preventDefault();
    const name = document.getElementById('character-name').value.trim();
    const init = parseInt(document.getElementById('initiative-roll').value, 10);
    const maxHP = parseInt(document.getElementById('character-health').value, 10);
    const notes = document.getElementById('character-notes').value.trim();
    if (!name || isNaN(init) || isNaN(maxHP)) return;

    characters.push({ name, initiative: init, currentHP: maxHP, maxHP, notes, status: [] });
    characters.sort((a, b) => b.initiative - a.initiative);
    e.target.reset();
    buildTable();
});

document.getElementById('clear-all').addEventListener('click', () => {
    characters = []; currentTurn = 0; combatRound = 1;
    buildTable();
});

document.getElementById('clear-storage').addEventListener('click', () => {
    localStorage.removeItem('initiativeTrackerData');
    alert('Saved tracker data cleared.');
});

document.getElementById('next-turn').addEventListener('click', () => {
    if (characters.length === 0) return;
    currentTurn = (currentTurn + 1) % characters.length;
    if (currentTurn === 0) combatRound++;
    buildTable();
});

document.getElementById('reset-turns').addEventListener('click', () => {
    currentTurn = 0; combatRound = 1; buildTable();
});

document.getElementById('save-status-btn').addEventListener('click', () => {
    const input = document.getElementById('new-status-input');
    const newEffect = input.value.trim();
    if (newEffect && modalCharacterIndex !== null) {
        const list = characters[modalCharacterIndex].status;
        if (!list.includes(newEffect)) list.push(newEffect);
    }
    buildTable();
    modal.hide();
});

window.addEventListener('beforeunload', () => {
    const state = {
        characters,
        currentTurn,
        combatRound
    };
    localStorage.setItem('initiativeTrackerData', JSON.stringify(state));
});

buildTable();
</script>
</body>
</html>